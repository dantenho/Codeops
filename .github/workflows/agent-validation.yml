name: Agent Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  detect-agent:
    name: Detect Agent
    runs-on: ubuntu-latest
    outputs:
      agent-name: ${{ steps.detect.outputs.agent }}
    steps:
      - uses: actions/checkout@v4
      - name: Detect agent from branch/commit
        id: detect
        run: |
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          if [[ "$BRANCH_NAME" == agent/* ]]; then
            AGENT=$(echo "$BRANCH_NAME" | cut -d'/' -f2)
            echo "agent=$AGENT" >> $GITHUB_OUTPUT
          else
            echo "agent=unknown" >> $GITHUB_OUTPUT
          fi

  validate-documentation:
    name: Validate Documentation
    runs-on: ubuntu-latest
    needs: detect-agent
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          pip install interrogate pydocstyle
      - name: Check docstring coverage
        run: |
          interrogate -v -i core/ agents/ github/ evaluation/ || true
      - name: Validate docstring format
        run: |
          pydocstyle core/ agents/ github/ evaluation/ --convention=google || true
      - name: Check operation tags
        run: |
          python -c "
          import re
          import sys
          from pathlib import Path

          errors = []
          for py_file in Path('.').rglob('*.py'):
              if '__pycache__' in str(py_file) or 'venv' in str(py_file):
                  continue
              content = py_file.read_text(encoding='utf-8', errors='ignore')
              if 'def ' in content or 'class ' in content:
                  if '[CREATE]' not in content and '[REFACTOR]' not in content and '[DEBUG]' not in content:
                      # Check if it's a main module or __init__
                      if '__main__' not in content and '__init__' not in str(py_file):
                          errors.append(f'{py_file}: Missing operation tag')

          if errors:
              print('Missing operation tags:')
              for e in errors[:10]:
                  print(f'  {e}')
              sys.exit(1)
          "

  validate-code-quality:
    name: Validate Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          pip install ruff black mypy
      - name: Run Ruff
        run: |
          ruff check . --output-format=github || true
      - name: Check formatting
        run: |
          black --check . || true
      - name: Type checking
        run: |
          mypy core/ agents/ github/ evaluation/ --ignore-missing-imports || true

  validate-telemetry:
    name: Validate Telemetry
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          pip install jsonschema
      - name: Validate telemetry schemas
        run: |
          python -c "
          import json
          import jsonschema
          from pathlib import Path

          schema_path = Path('schemas/operation_schema.json')
          if schema_path.exists():
              schema = json.loads(schema_path.read_text())
              # Validate schema structure
              jsonschema.Draft7Validator.check_schema(schema)
              print('Telemetry schema is valid')
          "

  compliance-report:
    name: Compliance Report
    runs-on: ubuntu-latest
    needs:
      [
        detect-agent,
        validate-documentation,
        validate-code-quality,
        validate-telemetry,
      ]
    if: always()
    steps:
      - name: Generate compliance report
        run: |
          echo "## Agent Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Agent: ${{ needs.detect-agent.outputs.agent-name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.validate-documentation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.validate-code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Telemetry | ${{ needs.validate-telemetry.result }} |" >> $GITHUB_STEP_SUMMARY
