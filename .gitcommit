# Commit Convention

## Format
```
<type>(<scope>): <subject>

<body>

<footer>
```

## Types
- **feat**: New feature or capability
- **fix**: Bug fix or issue resolution
- **refactor**: Code restructuring without behavior change
- **docs**: Documentation changes only
- **test**: Adding or updating tests
- **chore**: Build, deps, config, tooling
- **perf**: Performance improvements
- **style**: Code style changes (formatting, whitespace)
- **ci**: CI/CD pipeline changes
- **revert**: Reverting a previous commit

## Scopes

### Workspace Scopes
- **agents**: Agents workspace (packages/agents)
- **backend**: Backend workspace (packages/backend, backend/api)
- **frontend**: Frontend workspace (packages/frontend)
- **memory**: Memory module (packages/memory)
- **api**: API contracts and routers

### Shared Scopes
- **database**: Database schema, migrations, models
- **api-calls**: API endpoints and contracts
- **deps**: Cross-workspace dependencies
- **config**: Configuration files

### Special Scopes
- **monorepo**: Monorepo-wide changes (root-level)
- **ci**: Continuous integration
- **docs**: Documentation across workspaces

## Subject Guidelines
- Use imperative mood ("add" not "added" or "adds")
- Lowercase first letter
- No period at the end
- Max 72 characters
- Be specific and descriptive

## Body Guidelines
- Wrap at 72 characters
- Explain WHAT and WHY, not HOW
- Separate from subject with blank line
- Use bullet points for multiple changes
- Reference related issues/PRs

## Footer
- `Closes #123` - Closes an issue
- `Fixes #456` - Fixes a bug
- `Refs #789` - References related work
- `Breaking-Change:` - Breaking API changes
- `Co-authored-by:` - Multiple authors

## Examples

### Simple Feature
```
feat(memory): add vector similarity search

Implemented cosine similarity for vector queries.
Added new search endpoint in vector_store.py.

Closes #123
```

### Bug Fix
```
fix(backend): resolve race condition in task execution

The execute endpoint was not properly handling concurrent requests.
Added mutex lock to prevent duplicate task processing.

Fixes #456
```

### Breaking Change
```
feat(api): migrate to v2 authentication schema

Updated authentication to use JWT tokens instead of session cookies.
All clients must update their auth implementation.

Breaking-Change: Session-based auth removed
Refs #789
```

### Multi-Scope Change
```
refactor(database,backend): normalize user table schema

- Renamed `user_id` to `id` across all tables
- Updated foreign key references in agents workspace
- Migrated existing data with backward compatibility

Closes #234
```

### Documentation
```
docs(monorepo): update branch strategy and workflow

Added examples for handling merge conflicts.
Clarified sync process for shared branches.
```

## Branch Strategy

### Main Branches

#### Production
- **main**: Production-ready code (protected)
  - Receives merges from all workspace branches
  - Only tested, reviewed code
  - Tagged for releases

#### Workspace Branches (Independent Development)
- **workspace/agents**: Agents development
  - Scope: packages/agents, agent logic
  - Merges from: feature branches, shared branches

- **workspace/backend**: Backend development
  - Scope: packages/backend, backend/api
  - Merges from: feature branches, shared branches

- **workspace/frontend**: Frontend development
  - Scope: packages/frontend, UI components
  - Merges from: feature branches, shared branches

- **workspace/memory**: Memory module development
  - Scope: packages/memory, vector stores
  - Merges from: feature branches, shared/database

#### Shared Branches (Cross-Workspace)
- **shared/database**: Database schema & migrations
  - Syncs to: workspace/agents, workspace/backend, workspace/memory
  - Contains: SQL migrations, schema definitions, models

- **shared/api-calls**: API contracts & endpoints
  - Syncs to: All workspace branches
  - Contains: API specs, route definitions, DTOs

### Feature Branch Naming

#### Pattern
```
<type>/<scope>-<description>
```

#### Examples
- `feature/agents-vector-search`
- `fix/backend-auth-race-condition`
- `refactor/database-user-schema`
- `docs/api-endpoint-guide`
- `chore/ci-test-pipeline`

### Branch Dependency Graph
```
                    main (protected)
                   /  |  \  \
                  /   |   \  \
    workspace/agents  |    \  workspace/frontend
    workspace/backend |     \
    workspace/memory  |      \
                 \    |      /
                  \   |     /
                   shared/database
                   shared/api-calls
                        |
                   feature/* branches
```

## Workflows

### 1. Workspace Feature Development

**Starting a feature:**
```bash
# Update workspace branch
git checkout workspace/agents
git pull origin workspace/agents

# Create feature branch
git checkout -b feature/agents-vector-search

# Work on feature
git add .
git commit -m "feat(agents): add vector similarity search"

# Push feature branch
git push origin feature/agents-vector-search
```

**Merging to workspace:**
```bash
# Option A: Via Pull Request (recommended)
# Create PR: feature/agents-vector-search â†’ workspace/agents
# Review, approve, merge on GitHub/GitLab

# Option B: Direct merge
git checkout workspace/agents
git merge feature/agents-vector-search
git push origin workspace/agents

# Clean up
git branch -d feature/agents-vector-search
git push origin --delete feature/agents-vector-search
```

### 2. Shared Changes (Database/API)

**Making shared changes:**
```bash
# Update shared branch
git checkout shared/database
git pull origin shared/database

# Create feature branch from shared
git checkout -b feature/database-user-schema

# Make changes and commit
git add .
git commit -m "feat(database): add user preferences table"

# Push and merge to shared
git push origin feature/database-user-schema
git checkout shared/database
git merge feature/database-user-schema
git push origin shared/database
```

**Syncing to dependent workspaces:**
```bash
# Sync database changes to agents
git checkout workspace/agents
git pull origin workspace/agents
git merge shared/database
git push origin workspace/agents

# Sync database changes to backend
git checkout workspace/backend
git pull origin workspace/backend
git merge shared/database
git push origin workspace/backend

# Sync database changes to memory
git checkout workspace/memory
git pull origin workspace/memory
git merge shared/database
git push origin workspace/memory
```

**Syncing API changes to all workspaces:**
```bash
# After merging to shared/api-calls
for branch in workspace/agents workspace/backend workspace/frontend; do
  git checkout $branch
  git pull origin $branch
  git merge shared/api-calls
  git push origin $branch
done
```

### 3. Release to Main

**Pre-release checklist:**
- [ ] All workspace tests passing
- [ ] Code reviews completed
- [ ] Documentation updated
- [ ] Version bumped in package.json
- [ ] CHANGELOG.md updated

**Release process:**
```bash
# Update main with all workspace changes
git checkout main
git pull origin main

# Merge workspace branches in order
git merge workspace/agents --no-ff -m "merge(agents): release v1.2.0"
git merge workspace/backend --no-ff -m "merge(backend): release v1.2.0"
git merge workspace/frontend --no-ff -m "merge(frontend): release v1.2.0"
git merge workspace/memory --no-ff -m "merge(memory): release v1.2.0"

# Tag release
git tag -a v1.2.0 -m "Release v1.2.0"

# Push to origin
git push origin main --tags
```

### 4. Hotfix Workflow

**Critical production fix:**
```bash
# Branch from main
git checkout main
git pull origin main
git checkout -b hotfix/critical-auth-bug

# Make minimal fix
git add .
git commit -m "fix(backend): resolve authentication bypass vulnerability"

# Merge to main
git checkout main
git merge hotfix/critical-auth-bug --no-ff
git tag -a v1.2.1 -m "Hotfix v1.2.1"
git push origin main --tags

# Backport to workspace branches
git checkout workspace/backend
git merge hotfix/critical-auth-bug
git push origin workspace/backend

# Clean up
git branch -d hotfix/critical-auth-bug
```

### 5. Conflict Resolution

**When merge conflicts occur:**
```bash
# During merge
git merge shared/database
# CONFLICT (content): Merge conflict in schema.sql

# View conflicted files
git status

# Resolve conflicts manually
# Edit conflicted files, choose correct version

# Stage resolved files
git add schema.sql

# Complete merge
git commit -m "merge(database): resolve schema conflicts"
git push origin workspace/agents
```

**Abort merge if needed:**
```bash
git merge --abort
```

### 6. Syncing Fork/Keeping Updated

**Regularly sync workspace branches:**
```bash
# Update all local workspace branches
git fetch origin

# For each workspace
git checkout workspace/agents
git merge origin/workspace/agents

git checkout workspace/backend
git merge origin/workspace/backend

git checkout workspace/frontend
git merge origin/workspace/frontend
```

## Best Practices

### Do
- âœ“ Keep commits atomic (one logical change)
- âœ“ Write descriptive commit messages
- âœ“ Sync shared branches regularly
- âœ“ Test before merging to workspace branches
- âœ“ Use pull requests for code review
- âœ“ Keep feature branches short-lived (< 1 week)
- âœ“ Rebase feature branches on workspace before merge
- âœ“ Delete feature branches after merge

### Don't
- âœ— Commit directly to main or workspace branches
- âœ— Force push to shared or workspace branches
- âœ— Merge without testing
- âœ— Create circular dependencies between workspaces
- âœ— Modify shared branches without syncing
- âœ— Use ambiguous commit messages
- âœ— Mix multiple unrelated changes in one commit
- âœ— Leave feature branches stale

## Troubleshooting

### Problem: Merge conflicts in shared branch
**Solution:** Coordinate with team, sync before making changes
```bash
git checkout shared/database
git pull origin shared/database
# Then make your changes
```

### Problem: Accidentally committed to wrong branch
**Solution:** Cherry-pick to correct branch
```bash
# Note the commit hash
git log

# Switch to correct branch
git checkout feature/correct-branch
git cherry-pick <commit-hash>

# Remove from wrong branch
git checkout wrong-branch
git reset --hard HEAD~1
```

### Problem: Need to update feature branch with workspace changes
**Solution:** Rebase on workspace branch
```bash
git checkout feature/my-feature
git fetch origin
git rebase origin/workspace/agents
git push --force-with-lease origin feature/my-feature
```

## Branch Locking & Coordination

### Purpose
Prevent merge conflicts and coordination issues when multiple developers work on shared branches simultaneously.

### Lock Protocol

#### Before Working on Shared Branches
1. **Check lock status** in team communication channel (Slack/Discord/Teams)
2. **Announce intent** to work on shared branch
3. **Wait for acknowledgment** from team
4. **Acquire lock** by creating lock file

#### Lock File System

**Location:** `.git/locks/` (git-ignored directory)

**Lock file format:** `<branch-name>.lock`

**Example lock file:** `.git/locks/shared-database.lock`
```json
{
  "branch": "shared/database",
  "locked_by": "developer@example.com",
  "locked_at": "2025-12-05T10:30:00Z",
  "reason": "Adding user preferences table migration",
  "estimated_completion": "2025-12-05T12:00:00Z"
}
```

#### Creating a Lock

**Automated script (recommended):**
```bash
#!/bin/bash
# lock-branch.sh

BRANCH=$1
REASON=$2
DURATION=${3:-"2 hours"}

mkdir -p .git/locks

cat > .git/locks/${BRANCH//\//-}.lock <<EOF
{
  "branch": "$BRANCH",
  "locked_by": "$(git config user.email)",
  "locked_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "reason": "$REASON",
  "estimated_completion": "$(date -u -d "+$DURATION" +%Y-%m-%dT%H:%M:%SZ)"
}
EOF

echo "Locked $BRANCH for $DURATION"
echo "Reason: $REASON"
```

**Usage:**
```bash
./lock-branch.sh shared/database "Adding user preferences table" "3 hours"
```

#### Checking Lock Status

```bash
#!/bin/bash
# check-lock.sh

BRANCH=$1
LOCK_FILE=".git/locks/${BRANCH//\//-}.lock"

if [ -f "$LOCK_FILE" ]; then
  echo "Branch $BRANCH is LOCKED:"
  cat "$LOCK_FILE" | jq .
  exit 1
else
  echo "Branch $BRANCH is available"
  exit 0
fi
```

#### Releasing a Lock

```bash
#!/bin/bash
# unlock-branch.sh

BRANCH=$1
LOCK_FILE=".git/locks/${BRANCH//\//-}.lock"

if [ -f "$LOCK_FILE" ]; then
  LOCKED_BY=$(cat "$LOCK_FILE" | jq -r .locked_by)
  CURRENT_USER=$(git config user.email)

  if [ "$LOCKED_BY" = "$CURRENT_USER" ]; then
    rm "$LOCK_FILE"
    echo "Unlocked $BRANCH"
  else
    echo "Error: Branch locked by $LOCKED_BY, you are $CURRENT_USER"
    exit 1
  fi
else
  echo "Branch $BRANCH is not locked"
fi
```

### Coordination Workflow

#### Scenario 1: Working on Shared Database Branch

**Developer A:**
```bash
# 1. Check if branch is locked
./check-lock.sh shared/database

# 2. Announce in team chat
# "Starting work on shared/database - adding user prefs table - ETA 2 hours"

# 3. Acquire lock
./lock-branch.sh shared/database "Adding user preferences table" "2 hours"

# 4. Work on branch
git checkout shared/database
git pull origin shared/database
git checkout -b feature/database-user-prefs

# Make changes...
git add .
git commit -m "feat(database): add user preferences table"

# 5. Merge and push
git checkout shared/database
git merge feature/database-user-prefs
git push origin shared/database

# 6. Release lock
./unlock-branch.sh shared/database

# 7. Notify team
# "Completed shared/database work - unlocked - please sync"
```

**Developer B (waiting):**
```bash
# Check lock status periodically
./check-lock.sh shared/database

# When unlocked, sync immediately
git checkout shared/database
git pull origin shared/database

# Then acquire lock for their work
./lock-branch.sh shared/database "Adding product catalog schema" "1 hour"
```

#### Scenario 2: Emergency Override

**When urgent hotfix needed on locked branch:**
```bash
# Contact lock holder via team chat
# "Need to apply emergency security fix to shared/database"

# If no response after 15 min and truly urgent:
# Document in team chat
# Force unlock (last resort)
BRANCH="shared/database"
rm .git/locks/${BRANCH//\//-}.lock

# Apply fix
git checkout shared/database
git checkout -b hotfix/security-patch
# ... make changes ...

# Merge and notify
git checkout shared/database
git merge hotfix/security-patch
git push origin shared/database

# Notify team immediately
# "Emergency hotfix applied to shared/database - please sync"
```

### Communication Channels

#### Required Notifications

**Before locking:**
- [ ] Announce in team channel
- [ ] Specify branch name
- [ ] Explain what you're doing
- [ ] Estimate completion time

**After unlocking:**
- [ ] Notify completion in team channel
- [ ] Summarize changes made
- [ ] Tag affected workspace maintainers
- [ ] Remind to sync dependent branches

#### Team Channel Examples

**Slack/Discord channel:** `#git-coordination`

**Message templates:**
```
ðŸ”’ LOCK: shared/database
ðŸ“ Reason: Adding user preferences table migration
ðŸ‘¤ Developer: @alice
â±ï¸ ETA: 2 hours (until 12:00 PM UTC)
```

```
ðŸ”“ UNLOCK: shared/database
âœ… Completed: User preferences table added
ðŸ“¦ Files changed: migrations/003_user_prefs.sql, models/user.py
ðŸ”„ Action needed: Sync to workspace/agents, workspace/backend
ðŸ‘¥ CC: @backend-team @agents-team
```

### Lock Rules

#### Mandatory Locks
These branches ALWAYS require locks:
- `shared/database`
- `shared/api-calls`

#### Optional Locks
These branches recommended but not required:
- `workspace/agents`
- `workspace/backend`
- `workspace/frontend`
- `workspace/memory`

#### No Lock Required
- Feature branches (`feature/*`)
- Hotfix branches (`hotfix/*`)
- Personal branches
- `main` (protected, requires PR)

### Lock Duration Guidelines

| Type of Work | Recommended Duration | Maximum Duration |
|--------------|---------------------|------------------|
| Small schema change | 1-2 hours | 4 hours |
| Major migration | 4-6 hours | 1 day |
| API contract update | 2-3 hours | 6 hours |
| Emergency hotfix | 30 min | 2 hours |

### Handling Stale Locks

**Auto-cleanup script (run via cron/scheduled task):**
```bash
#!/bin/bash
# cleanup-stale-locks.sh

LOCK_DIR=".git/locks"
NOW=$(date +%s)

for lock_file in $LOCK_DIR/*.lock; do
  if [ -f "$lock_file" ]; then
    COMPLETION=$(cat "$lock_file" | jq -r .estimated_completion)
    COMPLETION_TS=$(date -d "$COMPLETION" +%s)

    if [ $NOW -gt $COMPLETION_TS ]; then
      LOCKED_BY=$(cat "$lock_file" | jq -r .locked_by)
      BRANCH=$(cat "$lock_file" | jq -r .branch)

      echo "Stale lock detected:"
      echo "  Branch: $BRANCH"
      echo "  Locked by: $LOCKED_BY"
      echo "  Estimated completion: $COMPLETION"

      # Notify team
      # Post to Slack/Discord: "Stale lock on $BRANCH by $LOCKED_BY"

      # Optional: Auto-remove after 2x estimated time
      # rm "$lock_file"
    fi
  fi
done
```

### Git Hooks Integration

**Pre-commit hook (`.git/hooks/pre-commit`):**
```bash
#!/bin/bash

BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Check if branch requires lock
if [[ "$BRANCH" == "shared/"* ]]; then
  LOCK_FILE=".git/locks/${BRANCH//\//-}.lock"

  if [ ! -f "$LOCK_FILE" ]; then
    echo "ERROR: Branch $BRANCH requires a lock before committing"
    echo "Run: ./lock-branch.sh $BRANCH \"reason\" \"duration\""
    exit 1
  fi

  LOCKED_BY=$(cat "$LOCK_FILE" | jq -r .locked_by)
  CURRENT_USER=$(git config user.email)

  if [ "$LOCKED_BY" != "$CURRENT_USER" ]; then
    echo "ERROR: Branch locked by $LOCKED_BY, you are $CURRENT_USER"
    exit 1
  fi
fi

exit 0
```

### Setup Instructions

**Initialize lock system:**
```bash
# 1. Create locks directory
mkdir -p .git/locks

# 2. Add to .gitignore
echo ".git/locks/" >> .gitignore

# 3. Copy scripts to repo
cp lock-branch.sh unlock-branch.sh check-lock.sh .git/hooks/

# 4. Make executable
chmod +x .git/hooks/*.sh

# 5. Install pre-commit hook
cp pre-commit .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit

# 6. Configure team channel
# Set up Slack/Discord webhook for notifications
```

### Quick Reference

**Check lock:**
```bash
./check-lock.sh shared/database
```

**Acquire lock:**
```bash
./lock-branch.sh shared/database "Migration work" "2 hours"
```

**Release lock:**
```bash
./unlock-branch.sh shared/database
```

**View all locks:**
```bash
ls -la .git/locks/ && cat .git/locks/*.lock | jq .
```

**Force unlock (emergency only):**
```bash
rm .git/locks/shared-database.lock
```
