name: Dependency Updates & Security

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'

  workflow_dispatch:
    inputs:
      update_type:
        description: 'Update type'
        type: choice
        options:
          - patch
          - minor
          - major
          - all
        default: 'minor'
      create_pr:
        description: 'Create PR automatically'
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Check for Python dependency updates
  check-python-deps:
    runs-on: ubuntu-latest
    name: Check Python Dependencies
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      update_list: ${{ steps.check.outputs.update_list }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-check-updates
        run: |
          pip install pip-tools pip-audit pur

      - name: Check for updates
        id: check
        run: |
          echo "Checking for dependency updates..."

          # Generate current dependencies
          pip freeze > current_deps.txt

          # Check for updates
          pur -r requirements.txt --dry-run > updates.txt 2>&1 || true

          if grep -q "Updated" updates.txt; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "update_list<<EOF" >> $GITHUB_OUTPUT
            cat updates.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Security audit
        id: audit
        run: |
          pip-audit --format json > audit_results.json || true

          if [ -s audit_results.json ]; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload audit results
        if: steps.audit.outputs.vulnerabilities_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: audit_results.json

  # Update Python dependencies
  update-python-deps:
    runs-on: ubuntu-latest
    name: Update Python Dependencies
    needs: check-python-deps
    if: needs.check-python-deps.outputs.has_updates == 'true'

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create update branch
        run: |
          BRANCH_NAME="deps/python-updates-$(date +%Y%m%d)"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Update dependencies
        run: |
          pip install pur

          # Update based on input
          case "${{ inputs.update_type }}" in
            patch)
              pur -r requirements.txt --patch
              ;;
            minor)
              pur -r requirements.txt --minor
              ;;
            major)
              pur -r requirements.txt
              ;;
            all)
              pur -r requirements.txt
              ;;
            *)
              pur -r requirements.txt --minor
              ;;
          esac

      - name: Test updated dependencies
        run: |
          pip install -r requirements.txt
          python -c "import sys; print('Dependencies installed successfully')"

      - name: Run tests with new dependencies
        run: |
          pip install pytest
          pytest tests/ --maxfail=5 || echo "Tests failed with new dependencies"

      - name: Commit changes
        run: |
          git add requirements.txt
          git commit -m "chore(deps): update Python dependencies

          Automated dependency update
          Update type: ${{ inputs.update_type || 'minor' }}

          ${{ needs.check-python-deps.outputs.update_list }}

          Generated by GitHub Actions"

      - name: Push branch
        run: |
          git push origin $BRANCH_NAME

      - name: Create Pull Request
        if: inputs.create_pr != false
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'chore(deps): Update Python dependencies',
              head: process.env.BRANCH_NAME,
              base: 'main',
              body: `## Dependency Updates

              Automated Python dependency updates.

              ### Update Type
              \`${{ inputs.update_type || 'minor' }}\`

              ### Changes
              \`\`\`
              ${{ needs.check-python-deps.outputs.update_list }}
              \`\`\`

              ### Testing
              - [ ] All tests pass
              - [ ] No security vulnerabilities
              - [ ] Manual testing completed

              ---
              *Generated by GitHub Actions*
              Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              `
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['dependencies', 'automated']
            });

  # Check for Node.js dependency updates
  check-node-deps:
    runs-on: ubuntu-latest
    name: Check Node.js Dependencies
    if: hashFiles('package.json') != ''
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check for updates
        id: check
        run: |
          npm outdated > outdated.txt || true

          if [ -s outdated.txt ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Security audit
        run: |
          npm audit --json > npm_audit.json || true

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-security-audit
          path: npm_audit.json

  # Security vulnerability scanner
  security-scan:
    runs-on: ubuntu-latest
    name: Security Vulnerability Scan

    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Bandit security linter
        run: |
          pip install bandit
          bandit -r packages/ nodes/ -f json -o bandit-results.json || true

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-scan
          path: bandit-results.json

  # Check for CVEs in dependencies
  cve-check:
    runs-on: ubuntu-latest
    name: CVE Check

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install safety
        run: pip install safety

      - name: Check for CVEs
        id: safety
        run: |
          safety check --json > safety-results.json || true

          if grep -q "vulnerabilities" safety-results.json; then
            echo "cves_found=true" >> $GITHUB_OUTPUT
          else
            echo "cves_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for CVEs
        if: steps.safety.outputs.cves_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('safety-results.json', 'utf8'));

            const title = `Security Alert: CVEs Found in Dependencies`;
            const labels = ['security', 'critical'];

            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels.join(','),
              state: 'open'
            });

            const body = `## Security Vulnerabilities Detected

            The automated security scan found vulnerabilities in project dependencies.

            ### Details
            \`\`\`json
            ${JSON.stringify(results, null, 2)}
            \`\`\`

            ### Action Required
            - [ ] Review vulnerabilities
            - [ ] Update affected packages
            - [ ] Test changes
            - [ ] Deploy fixes

            **Priority**: CRITICAL
            **Scan Date**: ${new Date().toISOString()}
            **Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            `;

            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                labels,
                body
              });
            }

  # Generate dependency report
  report:
    runs-on: ubuntu-latest
    name: Generate Report
    needs: [check-python-deps, security-scan, cve-check]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "## Dependency & Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Updates | ${{ needs.check-python-deps.outputs.has_updates == 'true' && '⚠️ Available' || '✅ Up to date' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CVE Check | ${{ needs.cve-check.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify team
        if: |
          needs.check-python-deps.outputs.has_updates == 'true' ||
          needs.cve-check.outputs.cves_found == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "Dependency Update Available",
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: "*Dependency & Security Update*\n\n• Python Updates: ${{ needs.check-python-deps.outputs.has_updates }}\n• Security Issues: ${{ needs.cve-check.outputs.cves_found }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Report>"
                  }
                }
              ]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
