# .github/workflows/merge-orchestrator.yml
#
# [MODIFY] Orchestrates the merge process for agent PRs.
# Ensures that merges only happen when all checks pass and handles
# automatic merging for trusted agents on safe paths.
# Enhanced with proper PR detection and GitHub API integration.
#
# Agent: Composer
# Timestamp: 2025-12-03T23:30:00Z

name: Merge Orchestrator

on:
  pull_request:
    types: [labeled, synchronize, opened, reopened]
  workflow_run:
    workflows: ["Agent Compliance Validation"]
    types:
      - completed

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 1: Check validation status and identify PR
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  check-validation:
    name: ‚úÖ Check Validation
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      pr_number: ${{ steps.pr.outputs.number }}
      agent: ${{ steps.pr.outputs.agent }}
      should_merge: ${{ steps.pr.outputs.should_merge }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Identify PR and Agent
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            let agent = 'Unknown';

            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
              // Extract agent from branch name
              const branchName = context.payload.pull_request.head.ref;
              const match = branchName.match(/^agent\/([^/]+)/);
              if (match) {
                agent = match[1];
              }
            } else if (context.eventName === 'workflow_run') {
              // Get PRs associated with the workflow run
              const workflowRun = context.payload.workflow_run;
              const commits = await github.rest.repos.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: workflowRun.head_sha
              });

              if (commits.data.length > 0) {
                const commitSha = commits.data[0].sha;
                const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: commitSha
                });

                if (prs.data.length > 0) {
                  prNumber = prs.data[0].number;
                  const branchName = prs.data[0].head.ref;
                  const match = branchName.match(/^agent\/([^/]+)/);
                  if (match) {
                    agent = match[1];
                  }
                }
              }
            }

            const shouldMerge = context.payload.pull_request?.labels?.some(
              label => label.name === 'auto-merge'
            ) || false;

            core.setOutput('number', prNumber || '');
            core.setOutput('agent', agent);
            core.setOutput('should_merge', shouldMerge ? 'true' : 'false');

            console.log(`PR #${prNumber}, Agent: ${agent}, Should Merge: ${shouldMerge}`);

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 2: Check PR status and requirements
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  check-pr-status:
    name: üîç Check PR Status
    runs-on: ubuntu-latest
    needs: check-validation
    if: needs.check-validation.outputs.pr_number != ''
    outputs:
      ready_to_merge: ${{ steps.check.outputs.ready }}
      merge_method: ${{ steps.check.outputs.method }}

    steps:
      - name: Check PR requirements
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-validation.outputs.pr_number }};
            const agent = "${{ needs.check-validation.outputs.agent }}";
            const shouldMerge = "${{ needs.check-validation.outputs.should_merge }}" === 'true';

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const checks = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.data.head.sha
            });

            // Check if all required checks pass
            const requiredChecks = ['Agent Compliance Validation'];
            const allChecksPassed = checks.data.check_runs.every(
              check => check.status === 'completed' && check.conclusion === 'success'
            );

            // Check if PR is mergeable
            const isMergeable = pr.data.mergeable &&
                               pr.data.mergeable_state === 'clean' &&
                               !pr.data.draft &&
                               allChecksPassed;

            // Determine merge method based on agent and PR size
            let mergeMethod = 'squash';
            const trustedAgents = ['GrokIA', 'GeminiPro30', 'Composer', 'ClaudeCode'];
            const largeChangeThreshold = 50; // files changed

            if (pr.data.changed_files > largeChangeThreshold) {
              mergeMethod = 'merge'; // Preserve history for large changes
            } else if (trustedAgents.includes(agent) && shouldMerge) {
              mergeMethod = 'squash'; // Clean history for trusted agents
            }

            core.setOutput('ready', isMergeable && shouldMerge ? 'true' : 'false');
            core.setOutput('method', mergeMethod);

            console.log(`PR #${prNumber}: Ready=${isMergeable}, Method=${mergeMethod}`);

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 3: Auto-merge (if safe)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  auto-merge:
    name: üîÑ Auto Merge
    runs-on: ubuntu-latest
    needs: [check-validation, check-pr-status]
    if: |
      needs.check-validation.outputs.pr_number != '' &&
      needs.check-pr-status.outputs.ready_to_merge == 'true'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-validation.outputs.pr_number }};
            const agent = "${{ needs.check-validation.outputs.agent }}";
            const mergeMethod = "${{ needs.check-pr-status.outputs.merge_method }}";

            try {
              console.log(`Merging PR #${prNumber} from ${agent} using ${mergeMethod} method`);

              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: mergeMethod,
                commit_title: `Merge PR #${prNumber} from ${agent} [Auto-Merge]`
              });

              console.log(`‚úÖ Successfully merged PR #${prNumber}`);

              // Add comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `‚úÖ **Auto-merged** by Merge Orchestrator\n\n- Agent: ${agent}\n- Method: ${mergeMethod}\n- All checks passed`
              });
            } catch (error) {
              console.error(`‚ùå Failed to merge PR #${prNumber}:`, error.message);

              // Add comment about failure
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `‚ùå **Auto-merge failed**\n\nReason: ${error.message}\n\nPlease merge manually after resolving issues.`
              });

              core.setFailed(`Failed to merge PR: ${error.message}`);
            }

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 4: Notify on failure
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  notify-failure:
    name: üö® Notify Failure
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      (github.event_name == 'pull_request' && github.event.action != 'closed')
    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;

            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'workflow_run') {
              const workflowRun = context.payload.workflow_run;
              const commits = await github.rest.repos.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: workflowRun.head_sha
              });

              if (commits.data.length > 0) {
                const commitSha = commits.data[0].sha;
                const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: commitSha
                });

                if (prs.data.length > 0) {
                  prNumber = prs.data[0].number;
                }
              }
            }

            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `‚ö†Ô∏è **Validation Failed**\n\nPlease check the workflow logs and fix any issues before merging.\n\n[View Workflow Run](${context.payload.workflow_run?.html_url || 'N/A'})`
              });
            }
